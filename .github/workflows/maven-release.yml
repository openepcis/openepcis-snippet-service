name: Build Release with Maven

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: openepcis-snippet-service

jobs:
  build:
    name: 'Build and Test'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up GraalVM 21
        uses: graalvm/setup-graalvm@v1
        with:
          java-version: '21'
          distribution: 'graalvm-community'
          cache: maven

      - name: Build and Test
        run: |
          ./mvnw \
            --no-transfer-progress \
            --batch-mode \
            clean verify

  build-container-images:
    name: 'Build Container Images'
    needs: [build]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get Version from tag
        if: startsWith(github.ref, 'refs/tags/v')
        uses: olegtarasov/get-tag@v2.1.3
        id: tagName
        with:
          tagRegex: "v(.*)"
          tagRegexGroup: 1

      - name: Set version for branch build
        if: "!startsWith(github.ref, 'refs/tags/v')"
        run: echo "GIT_TAG_NAME=latest" >> $GITHUB_ENV

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up GraalVM 21
        uses: graalvm/setup-graalvm@v1
        with:
          java-version: '21'
          distribution: 'graalvm-community'
          cache: maven

      - name: Build linux/amd64 Image
        run: |
          ./mvnw --no-transfer-progress --batch-mode \
            clean package -DskipTests \
            -Dquarkus.container-image.name=${{ env.IMAGE_NAME }} \
            -Dquarkus.container-image.build=true \
            -Dquarkus.container-image.registry=${{ env.REGISTRY }} \
            -Dquarkus.container-image.group=openepcis \
            -Dquarkus.jib.base-jvm-image=eclipse-temurin:21-jre-alpine \
            -Dquarkus.container-image.additional-tags=latest-amd64,${GIT_TAG_NAME}-amd64 \
            -Dquarkus.jib.platforms=linux/amd64

      - name: Build linux/arm64 Image
        run: |
          ./mvnw --no-transfer-progress --batch-mode \
            clean package -DskipTests \
            -Dquarkus.container-image.name=${{ env.IMAGE_NAME }} \
            -Dquarkus.container-image.build=true \
            -Dquarkus.container-image.registry=${{ env.REGISTRY }} \
            -Dquarkus.container-image.group=openepcis \
            -Dquarkus.jib.base-jvm-image=eclipse-temurin:21-jre-alpine \
            -Dquarkus.container-image.additional-tags=latest-arm64,${GIT_TAG_NAME}-arm64 \
            -Dquarkus.jib.platforms=linux/arm64/v8

      - name: Push images and create multi-arch manifest
        run: |
          docker push ${{ env.REGISTRY }}/openepcis/${{ env.IMAGE_NAME }}:${GIT_TAG_NAME}-amd64
          docker push ${{ env.REGISTRY }}/openepcis/${{ env.IMAGE_NAME }}:${GIT_TAG_NAME}-arm64
          docker push ${{ env.REGISTRY }}/openepcis/${{ env.IMAGE_NAME }}:latest-amd64
          docker push ${{ env.REGISTRY }}/openepcis/${{ env.IMAGE_NAME }}:latest-arm64

          export DOCKER_CLI_EXPERIMENTAL=enabled

          # Create and push versioned multi-arch manifest
          docker manifest create ${{ env.REGISTRY }}/openepcis/${{ env.IMAGE_NAME }}:${GIT_TAG_NAME} \
            --amend ${{ env.REGISTRY }}/openepcis/${{ env.IMAGE_NAME }}:${GIT_TAG_NAME}-amd64 \
            --amend ${{ env.REGISTRY }}/openepcis/${{ env.IMAGE_NAME }}:${GIT_TAG_NAME}-arm64
          docker manifest push ${{ env.REGISTRY }}/openepcis/${{ env.IMAGE_NAME }}:${GIT_TAG_NAME}

          # Create and push latest multi-arch manifest
          docker manifest create ${{ env.REGISTRY }}/openepcis/${{ env.IMAGE_NAME }}:latest \
            --amend ${{ env.REGISTRY }}/openepcis/${{ env.IMAGE_NAME }}:latest-amd64 \
            --amend ${{ env.REGISTRY }}/openepcis/${{ env.IMAGE_NAME }}:latest-arm64
          docker manifest push ${{ env.REGISTRY }}/openepcis/${{ env.IMAGE_NAME }}:latest

      - name: Push main branch tag
        if: github.ref == 'refs/heads/main'
        run: |
          docker tag ${{ env.REGISTRY }}/openepcis/${{ env.IMAGE_NAME }}:latest-amd64 ${{ env.REGISTRY }}/openepcis/${{ env.IMAGE_NAME }}:main-amd64
          docker tag ${{ env.REGISTRY }}/openepcis/${{ env.IMAGE_NAME }}:latest-arm64 ${{ env.REGISTRY }}/openepcis/${{ env.IMAGE_NAME }}:main-arm64
          docker push ${{ env.REGISTRY }}/openepcis/${{ env.IMAGE_NAME }}:main-amd64
          docker push ${{ env.REGISTRY }}/openepcis/${{ env.IMAGE_NAME }}:main-arm64

          export DOCKER_CLI_EXPERIMENTAL=enabled
          docker manifest create ${{ env.REGISTRY }}/openepcis/${{ env.IMAGE_NAME }}:main \
            --amend ${{ env.REGISTRY }}/openepcis/${{ env.IMAGE_NAME }}:main-amd64 \
            --amend ${{ env.REGISTRY }}/openepcis/${{ env.IMAGE_NAME }}:main-arm64
          docker manifest push ${{ env.REGISTRY }}/openepcis/${{ env.IMAGE_NAME }}:main
